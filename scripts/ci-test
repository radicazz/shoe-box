#!/usr/bin/env bash
set -euo pipefail

echo "üß™ Running CI tests..."
echo ""

EXIT_CODE=0

# Install dependencies (fresh)
echo "1Ô∏è‚É£  Installing dependencies..."
npm ci --quiet || { echo "  ‚úó npm ci failed"; exit 1; }
echo "  ‚úì Dependencies installed"

# Validate
echo ""
echo "2Ô∏è‚É£  Validating project structure..."
./scripts/validate || EXIT_CODE=1

# Build
echo ""
echo "3Ô∏è‚É£  Building production bundle..."
npm run build --quiet || { echo "  ‚úó Build failed"; exit 1; }
echo "  ‚úì Build successful"

# Check bundle size
echo ""
echo "4Ô∏è‚É£  Checking bundle size..."
DIST_SIZE=$(du -sb dist | cut -f1)
DIST_SIZE_KB=$((DIST_SIZE / 1024))

echo "  üì¶ Total size: ${DIST_SIZE_KB}KB"

# Warn if bundle is too large (500KB target per docs)
if [ $DIST_SIZE_KB -gt 500 ]; then
  echo "  ‚ö†Ô∏è  Warning: Bundle exceeds 500KB target"
fi

# Check index.html exists and has content
if [ ! -f dist/index.html ]; then
  echo "  ‚úó dist/index.html not found"
  EXIT_CODE=1
else
  HTML_SIZE=$(wc -c < dist/index.html)
  if [ $HTML_SIZE -lt 100 ]; then
    echo "  ‚úó dist/index.html seems empty ($HTML_SIZE bytes)"
    EXIT_CODE=1
  else
    echo "  ‚úì dist/index.html valid ($HTML_SIZE bytes)"
  fi
fi

echo ""
if [ $EXIT_CODE -eq 0 ]; then
  echo "‚úÖ All CI tests passed!"
else
  echo "‚ùå CI tests failed!"
fi

exit $EXIT_CODE
